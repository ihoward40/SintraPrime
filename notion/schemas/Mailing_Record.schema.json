{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "sintraprime://schemas/mailing_record.schema.json",
  "title": "Mailing Record",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "id",
    "run_id",
    "recipient",
    "usps_certified_number",
    "mailing_date_utc",
    "contents_sha256",
    "delivery_status",
    "delivery_date_utc"
  ],
  "properties": {
    "id": {
      "type": "string",
      "pattern": "^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-5][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}$",
      "description": "Stable UUID for this mailing record."
    },
    "run_id": {
      "type": "string",
      "minLength": 3,
      "maxLength": 128,
      "pattern": "^[A-Za-z0-9][A-Za-z0-9._-]{2,127}$",
      "description": "Identifier of the run/ledger this mailing is associated with (format is project-defined)."
    },
    "created_utc": {
      "type": "string",
      "format": "date-time",
      "description": "Optional metadata timestamp. Must be explicitly provided; never auto-injected."
    },
    "recipient": {
      "type": "object",
      "additionalProperties": false,
      "required": ["name", "address_lines", "locality", "region", "postal_code", "country"],
      "properties": {
        "name": { "type": "string", "minLength": 1, "maxLength": 240 },
        "address_lines": {
          "type": "array",
          "minItems": 1,
          "maxItems": 4,
          "items": { "type": "string", "minLength": 1, "maxLength": 120 }
        },
        "locality": { "type": "string", "minLength": 1, "maxLength": 120, "description": "City / locality." },
        "region": { "type": "string", "minLength": 1, "maxLength": 120, "description": "State / region." },
        "postal_code": { "type": "string", "minLength": 1, "maxLength": 24 },
        "country": { "type": "string", "minLength": 2, "maxLength": 2, "description": "ISO 3166-1 alpha-2 (e.g., 'US')." }
      }
    },
    "usps_certified_number": {
      "type": "string",
      "minLength": 10,
      "maxLength": 40,
      "pattern": "^[0-9 ]{10,40}$",
      "description": "Certified mail tracking/label number as recorded on the receipt/label (digits/spaces only)."
    },
    "mailing_date_utc": {
      "type": "string",
      "format": "date-time",
      "description": "Mailing/dispatch timestamp (UTC)."
    },
    "contents_sha256": {
      "type": "string",
      "pattern": "^[a-fA-F0-9]{64}$",
      "description": "SHA-256 hex of the mailed packet contents (or its canonical ZIP/PDF representation)."
    },
    "contents_label": {
      "type": "string",
      "maxLength": 240,
      "description": "Human label for the packet contents (non-authoritative)."
    },
    "scans": {
      "type": "array",
      "minItems": 0,
      "maxItems": 50,
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["kind", "sha256", "captured_utc"],
        "properties": {
          "kind": {
            "type": "string",
            "enum": ["receipt", "label", "delivery_scan", "return_scan", "other"]
          },
          "sha256": { "type": "string", "pattern": "^[a-fA-F0-9]{64}$" },
          "captured_utc": { "type": "string", "format": "date-time" },
          "uri": { "type": "string", "maxLength": 2048, "description": "Optional location/URL (may be internal)." },
          "notes": { "type": "string", "maxLength": 2000 }
        }
      },
      "description": "Optional evidence attachments (scans/photos) referenced by hash."
    },
    "delivery_status": {
      "type": "string",
      "enum": ["pending", "in_transit", "delivered", "returned", "unclaimed", "unknown"],
      "description": "Status derived from evidence; never infer delivery without a corresponding scan/event."
    },
    "delivery_date_utc": {
      "type": ["string", "null"],
      "format": "date-time",
      "description": "UTC timestamp of delivery outcome when known; must be null for non-final statuses."
    }
  },
  "allOf": [
    {
      "if": {
        "properties": { "delivery_status": { "enum": ["delivered", "returned", "unclaimed"] } },
        "required": ["delivery_status"]
      },
      "then": {
        "properties": { "delivery_date_utc": { "type": "string", "format": "date-time" } },
        "required": ["delivery_date_utc"]
      }
    },
    {
      "if": {
        "properties": { "delivery_status": { "enum": ["pending", "in_transit", "unknown"] } },
        "required": ["delivery_status"]
      },
      "then": {
        "properties": { "delivery_date_utc": { "type": "null" } },
        "required": ["delivery_date_utc"]
      }
    }
  ]
}
