name: Require Governance Wiring Scope

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  wiring-scope-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect runtime-adjacent changes
        id: changes
        run: |
          # Use the PR file list from the GitHub API.
          # This is robust even when base/head histories have no merge-base.
          CHANGED=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files" \
            --paginate \
            --jq '.[].filename'
          )
          printf "%s\n" "$CHANGED" > changed_files.txt
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Enforce wiring scope
        run: |
          set -e
          RUNTIME_REGEX='^(agent-mode-engine/|src/|scripts/|make/|notion/)'
          if grep -E "$RUNTIME_REGEX" changed_files.txt >/dev/null; then
            if [ ! -f docs/governance/wiring-scope.md ]; then
              echo "ERROR: Runtime-adjacent changes detected but wiring-scope.md is missing."
              echo "Add docs/governance/wiring-scope.md and declare scope explicitly."
              exit 1
            fi
          fi

      - name: Pass
        run: echo "Governance wiring scope check passed."
