name: governance

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: read

jobs:
  wiring-scope:
    name: wiring-scope
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Fetch PR files (paginated)
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const fs = require('node:fs');
            fs.mkdirSync('.tmp', { recursive: true });

            const pull_number = context.payload.pull_request.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            let files;
            try {
              files = await github.paginate(github.rest.pulls.listFiles, {
                owner,
                repo,
                pull_number,
                per_page: 100,
              });
            } catch (err) {
              core.setFailed(
                `Could not fetch PR file list from GitHub API (required for wiring-scope-check): ${err?.message || err}`,
              );
              return;
            }

            fs.writeFileSync('.tmp/pr-files.json', JSON.stringify(files, null, 2));
            core.info(`Fetched ${files.length} PR files for ${owner}/${repo}#${pull_number}`);

      - name: Enforce wiring scope (shared script)
        run: |
          set -euo pipefail
          node ./scripts/ci/require-wiring-scope-from-pr-files.mjs | tee .tmp/wiring-scope.out
          # “CI lies sometimes” guardrail: ensure we extracted at least one file.
          COUNT="$(grep -Eo 'WIRING_SCOPE_CHANGED_FILES_COUNT=[0-9]+' .tmp/wiring-scope.out | tail -n 1 | cut -d= -f2)"
          test "${COUNT:-0}" -gt 0
          echo "WIRING_SCOPE_CONTEXT repo=${{ github.repository }} pr=${{ github.event.pull_request.number }} changed_files_count=${COUNT}"
          echo "::notice title=Wiring Scope Context::repo=${{ github.repository }} pr=${{ github.event.pull_request.number }} files=${COUNT}"
        env:
          PR_FILES_JSON_PATH: .tmp/pr-files.json
          RUNTIME_ADJACENT_PREFIXES: |
            agent-mode-engine
            src
            scripts
            make
            notion
          WIRING_SCOPE_DOC_PATH: docs/governance/wiring-scope.md
          WIRING_SCOPE_REPO: ${{ github.repository }}
          WIRING_SCOPE_PR_NUMBER: ${{ github.event.pull_request.number }}

      - name: Pass
        run: echo "Governance wiring scope check passed."
