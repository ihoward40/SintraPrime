name: PR Scope Echo Bot

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: read

jobs:
  comment-scope:
    if: github.event.pull_request.base.ref == 'master'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract scope hash and diff summary
        id: extract
        run: |
          set -e
          SCOPE_FILE="docs/governance/wiring-scope.md"

          if [ -f "$SCOPE_FILE" ]; then
            SCOPE_HASH=$(grep -E "Scope Hash \\(SHA-256\\):" "$SCOPE_FILE" | sed 's/.*: *//')
          else
            SCOPE_HASH="(missing)"
          fi

          git fetch origin ${{ github.base_ref }} --depth=1
          DIFF=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | sed 's/^/- /')

          echo "scope_hash=$SCOPE_HASH" >> $GITHUB_OUTPUT
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post PR comment
        uses: actions/github-script@v7
        env:
          SCOPE_HASH: ${{ steps.extract.outputs.scope_hash }}
          DIFF: ${{ steps.extract.outputs.diff }}
        with:
          script: |
            const scopeHash = process.env.SCOPE_HASH || "(missing)";
            const diff = process.env.DIFF || "- (no file changes detected)";

            const body = `
### Governance Wiring Scope Summary

**Scope Hash:** \`${scopeHash}\`

**Files changed in this PR:**
${diff}

> This comment is generated automatically to bind declared wiring intent
> to the concrete changes under review.
`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });
