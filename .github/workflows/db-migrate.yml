name: db-migrate (webapp drizzle)

on:
  workflow_dispatch:
    inputs:
      target:
        description: Environment to migrate
        required: true
        type: choice
        options:
          - staging
          - prod

permissions:
  contents: read

concurrency:
  group: db-migrate-${{ inputs.target }}
  cancel-in-progress: false

jobs:
  migrate-staging:
    if: ${{ inputs.target == 'staging' }}
    runs-on: ubuntu-latest
    environment: staging
    env:
      DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: webapp/pnpm-lock.yaml
      - name: Install deps (webapp)
        working-directory: webapp
        run: pnpm install --frozen-lockfile --prod=false --ignore-workspace
      - name: Apply Drizzle migrations (staging)
        working-directory: webapp
        run: pnpm --ignore-workspace exec drizzle-kit migrate

  migrate-prod:
    if: ${{ inputs.target == 'prod' }}
    runs-on: ubuntu-latest
    environment: production
    env:
      DATABASE_URL: ${{ secrets.PROD_DATABASE_URL }}
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: webapp/pnpm-lock.yaml
      - name: Install deps (webapp)
        working-directory: webapp
        run: pnpm install --frozen-lockfile --prod=false --ignore-workspace
      - name: Apply Drizzle migrations (prod)
        working-directory: webapp
        run: pnpm --ignore-workspace exec drizzle-kit migrate
