[
  {
    "name": "build-validation-dry",
    "stage": "planner",
    "command": "/build validation-agent {\"dry_run\":true}",
    "expect": { "kind": "ExecutionPlan" }
  },
  {
    "name": "build-validation-live",
    "stage": "planner",
    "command": "/build validation-agent {\"dry_run\":false}",
    "expect": { "kind": "ExecutionPlan" }
  },
  {
    "name": "unknown-command",
    "stage": "validation",
    "command": "/build does-not-exist",
    "expect": { "kind": "ValidatedCommand", "allowed": false }
  },
  {
    "name": "document-intake-dsl",
    "stage": "planner",
    "command": "/intake ./docs",
    "expect": { "kind": "ExecutionPlan" }
  },
  {
    "name": "document-intake-canonical",
    "stage": "planner",
    "command": "/build document-intake {\"path\":\"./docs\"}",
    "expect": { "kind": "ExecutionPlan" }
  },
  {
    "name": "document-intake-missing-path",
    "stage": "validation",
    "command": "/build document-intake {}",
    "expect": { "kind": "NeedInput" }
  },
  {
    "name": "document-intake-artifact-written",
    "stage": "cli",
    "command": "/intake ./docs",
    "env": {
      "ALLOWED_DOMAINS": null,
      "ALLOWED_METHODS": null,
      "command": "/template run close_case {\"page_id\":\"pg_001\",\"status\":\"Closed\",\"reason\":\"Docs received\"}",
      "NODE_ENV": null,
      "CONFIRM_PROD": null
    },
    "expect": { "status": "success" },
    "post_assert": {
      "artifact_dir": "runs/intake",
      "contains_keys": ["files", "path"]
    }
  },
  {
    "name": "capability-resolves-intake-scan",
    "stage": "cli",
    "command": "/intake ./docs",
    "env": {
      "ALLOWED_DOMAINS": null,
      "ALLOWED_METHODS": null,
      "ENVIRONMENT": null,
      "NODE_ENV": null,
      "CONFIRM_PROD": null
    },
    "expect": { "status": "success" },
    "post_assert": {
      "receipt_subset": {
        "status": "success",
        "resolved_capabilities": {
          "intake.scan": "document-intake-agent@1.0.0"
        }
      }
    }
  },
  {
    "name": "docs-capture-artifact-written",
    "stage": "cli",
    "command": "/docs capture http://localhost:8787/vendor/docs",
    "env": {
      "DOCS_CAPTURE_ALLOWED_HOSTS": "localhost",
      "ALLOWED_DOMAINS": null,
      "ALLOWED_METHODS": null,
      "ENVIRONMENT": null,
      "NODE_ENV": null,
      "CONFIRM_PROD": null
    },
    "expect": { "status": "success" },
    "post_assert": {
      "artifact_dir": "runs/docs",
      "contains_keys": ["url", "sha256_hex", "body_file", "byte_length"]
    }
  },
  {
    "name": "phases-happy-path",
    "stage": "cli",
    "command": "/intake ./docs",
    "planner_override": {
      "kind": "ExecutionPlan",
      "execution_id": "exec_mock_phases_happy_001",
      "threadId": "local_test_001",
      "dry_run": false,
      "goal": "Tier-5.2 phased happy path",
      "agent_versions": { "validator": "1.2.0", "planner": "1.1.3" },
      "assumptions": ["Generated by test-only planner override"],
      "required_secrets": [],
      "phases": [
        {
          "phase_id": "intake",
          "required_capabilities": ["intake.scan"],
          "steps": [
            {
              "step_id": "scan-path",
              "action": "scan_documents",
              "adapter": "WebhookAdapter",
              "method": "POST",
              "url": "http://localhost:8787/intake/scan",
              "payload": { "path": "./docs" },
              "expects": { "http_status": 200 },
              "idempotency_key": null
            }
          ],
          "outputs": ["files", "path"]
        },
        {
          "phase_id": "analysis",
          "required_capabilities": ["tax.analyze"],
          "inputs_from": ["intake"],
          "steps": [
            {
              "step_id": "analyze-files",
              "action": "tax_analyze",
              "adapter": "WebhookAdapter",
              "method": "POST",
              "url": "http://localhost:8787/tax/analyze",
              "expects": { "http_status": 200 },
              "idempotency_key": null
            }
          ]
        }
      ]
    },
    "expect": { "status": "success" },
    "post_assert": {
      "receipt_subset": {
        "status": "success",
        "phases_planned": ["intake", "analysis"],
        "phases_executed": ["intake", "analysis"],
        "resolved_capabilities": {
          "intake.scan": "document-intake-agent@1.0.0",
          "tax.analyze": "tax-agent@1.0.0"
        }
      }
    }
  },
  {
    "name": "phases-missing-capability",
    "stage": "cli",
    "command": "/intake ./docs",
    "planner_override": {
      "kind": "ExecutionPlan",
      "execution_id": "exec_mock_phases_missing_cap_001",
      "threadId": "local_test_001",
      "dry_run": false,
      "goal": "Tier-5.2 missing capability",
      "agent_versions": { "validator": "1.2.0", "planner": "1.1.3" },
      "assumptions": ["Generated by test-only planner override"],
      "required_secrets": [],
      "phases": [
        {
          "phase_id": "intake",
          "required_capabilities": ["intake.scan"],
          "steps": [
            {
              "step_id": "scan-path",
              "action": "scan_documents",
              "adapter": "WebhookAdapter",
              "method": "POST",
              "url": "http://localhost:8787/intake/scan",
              "payload": { "path": "./docs" },
              "expects": { "http_status": 200 },
              "idempotency_key": null
            }
          ],
          "outputs": ["files", "path"]
        },
        {
          "phase_id": "analysis",
          "required_capabilities": ["capability.does.not.exist"],
          "inputs_from": ["intake"],
          "steps": [
            {
              "step_id": "analyze-files",
              "action": "tax_analyze",
              "adapter": "WebhookAdapter",
              "method": "POST",
              "url": "http://localhost:8787/tax/analyze",
              "expects": { "http_status": 200 },
              "idempotency_key": null
            }
          ]
        }
      ]
    },
    "expect_exit_code": 3,
    "expect": { "kind": "PolicyDenied" },
    "post_assert": {
      "receipt_subset": {
        "status": "denied",
        "denied_phase": "analysis",
        "phases_planned": ["intake", "analysis"],
        "phases_executed": ["intake"],
        "policy_denied": { "code": "POLICY_CAPABILITY_UNRESOLVED" }
      }
    }
  },
  {
    "name": "phases-ordering-violation",
    "stage": "cli",
    "command": "/intake ./docs",
    "planner_override": {
      "kind": "ExecutionPlan",
      "execution_id": "exec_mock_phases_ordering_001",
      "threadId": "local_test_001",
      "dry_run": false,
      "goal": "Tier-5.2 ordering violation",
      "agent_versions": { "validator": "1.2.0", "planner": "1.1.3" },
      "assumptions": ["Generated by test-only planner override"],
      "required_secrets": [],
      "phases": [
        {
          "phase_id": "analysis",
          "required_capabilities": ["tax.analyze"],
          "inputs_from": ["intake"],
          "steps": [
            {
              "step_id": "analyze-files",
              "action": "tax_analyze",
              "adapter": "WebhookAdapter",
              "method": "POST",
              "url": "http://localhost:8787/tax/analyze",
              "expects": { "http_status": 200 },
              "idempotency_key": null
            }
          ]
        },
        {
          "phase_id": "intake",
          "required_capabilities": ["intake.scan"],
          "steps": [
            {
              "step_id": "scan-path",
              "action": "scan_documents",
              "adapter": "WebhookAdapter",
              "method": "POST",
              "url": "http://localhost:8787/intake/scan",
              "payload": { "path": "./docs" },
              "expects": { "http_status": 200 },
              "idempotency_key": null
            }
          ],
          "outputs": ["files", "path"]
        }
      ]
    },
    "expect_exit_code": 1,
    "expect": { "kind": "CliError", "code": "CLI_PHASES_INVALID" }
  },
  {
    "name": "phases-invalid-forward-reference",
    "stage": "cli",
    "command": "/intake ./docs",
    "planner_override": {
      "kind": "ExecutionPlan",
      "execution_id": "exec_mock_phases_invalid_forward_ref_001",
      "threadId": "local_test_001",
      "dry_run": false,
      "goal": "Tier-5.2 invalid forward reference",
      "agent_versions": { "validator": "1.2.0", "planner": "1.1.3" },
      "assumptions": ["Generated by test-only planner override"],
      "required_secrets": [],
      "phases": [
        {
          "phase_id": "analysis",
          "required_capabilities": ["tax.analyze"],
          "inputs_from": ["intake"],
          "steps": [
            {
              "step_id": "noop-analysis",
              "action": "noop",
              "adapter": "WebhookAdapter",
              "method": "GET",
              "url": "http://localhost:8787/status/200",
              "expects": { "http_status": 200 },
              "idempotency_key": null
            }
          ]
        },
        {
          "phase_id": "intake",
          "required_capabilities": ["intake.scan"],
          "steps": [
            {
              "step_id": "noop-intake",
              "action": "noop",
              "adapter": "WebhookAdapter",
              "method": "GET",
              "url": "http://localhost:8787/status/200",
              "expects": { "http_status": 200 },
              "idempotency_key": null
            }
          ]
        }
      ]
    },
    "expect_exit_code": 1,
    "expect": { "kind": "CliError", "code": "CLI_PHASES_INVALID" }
  },
  {
    "name": "policy-deny-domain",
    "stage": "cli",
    "command": "/build anything {\"noop\":true}",
    "env": {
      "THREAD_ID": "local_test_001",
      "ALLOWED_DOMAINS": "good.example.com"
    },
    "planner_override": {
      "kind": "ExecutionPlan",
      "execution_id": "policy_deny_domain_001",
      "threadId": "local_test_001",
      "dry_run": true,
      "goal": "Trigger domain allowlist policy denial",
      "agent_versions": { "validator": "1.2.0", "planner": "1.1.3" },
      "required_secrets": [],
      "steps": [
        {
          "step_id": "domain-check",
          "action": "ping",
          "adapter": "WebhookAdapter",
          "method": "GET",
          "url": "https://evil.example.com/ping",
          "expects": { "http_status": [200] },
          "idempotency_key": null
        }
      ]
    },
    "expect_exit_code": 3,
    "expect": { "kind": "PolicyDenied", "code": "DOMAIN_NOT_ALLOWED" },
    "post_assert": {
      "receipt_subset": { "status": "denied", "policy_denied": { "code": "DOMAIN_NOT_ALLOWED" } }
    }
  },
  {
    "name": "policy-deny-prod-write",
    "stage": "cli",
    "command": "/build anything {\"noop\":true}",
    "env": {
      "THREAD_ID": "local_test_001",
      "ENVIRONMENT": "production",
      "CONFIRM_PROD": null,
      "ALLOWED_DOMAINS": null,
      "ALLOWED_METHODS": null
    },
    "planner_override": {
      "kind": "ExecutionPlan",
      "execution_id": "policy_deny_prod_write_001",
      "threadId": "local_test_001",
      "dry_run": false,
      "goal": "Trigger production write approval requirement",
      "agent_versions": { "validator": "1.2.0", "planner": "1.1.3" },
      "required_secrets": [],
      "steps": [
        {
          "step_id": "prod-write",
          "action": "write",
          "adapter": "WebhookAdapter",
          "method": "POST",
          "url": "http://localhost:8787/intake/scan",
          "payload": { "path": "./docs" },
          "expects": { "http_status": [200] },
          "idempotency_key": null
        }
      ]
    },
    "expect_exit_code": 4,
    "expect": { "kind": "ApprovalRequired", "code": "WRITE_OPERATION" },
    "post_assert": {
      "receipt_subset": {
        "status": "awaiting_approval",
        "approval_required": { "kind": "ApprovalRequired", "code": "WRITE_OPERATION" }
      },
      "approval_state": true
    }
  },
  {
    "name": "approval-resume-prod-write",
    "stage": "cli",
    "command": "/approve policy_deny_prod_write_001",
    "env": { "ENVIRONMENT": "production" },
    "expect_exit_code": 0,
    "expect": { "status": "success" },
    "post_assert": {
      "receipt_subset": { "status": "success", "execution_id": "policy_deny_prod_write_001" },
      "resume_reused_plan_hash": true
    }
  },
  {
    "name": "notion-read-database-mock",
    "stage": "cli",
    "command": "/notion db db_mock_001",
    "env": {
      "ALLOWED_DOMAINS": null,
      "ALLOWED_METHODS": null,
      "ENVIRONMENT": null,
      "NODE_ENV": null,
      "CONFIRM_PROD": null
    },
    "expect_file_exists": "runs/notion/exec_mock_notion_db_001.read-database.json",
    "expect": { "status": "success" },
    "post_assert": {
      "artifact_dir": "runs/notion",
      "contains_keys": ["properties", "id"]
    }
  },
  {
    "name": "notion-write-approval-required",
    "stage": "cli",
    "command": "/notion set pg_001 Status=Done",
    "env": {
      "ALLOWED_DOMAINS": null,
      "ALLOWED_METHODS": null,
      "ENVIRONMENT": null,
      "NODE_ENV": null,
      "CONFIRM_PROD": null
    },
    "expect_exit_code": 4,
    "expect": { "kind": "ApprovalRequired", "code": "NOTION_WRITE_APPROVAL_REQUIRED" },
    "post_assert": {
      "approval_state": true
    }
  },
  {
    "name": "notion-write-approved",
    "stage": "cli",
    "command": "/approve exec_mock_notion_write_001",
    "env": {
      "ALLOWED_DOMAINS": null,
      "ALLOWED_METHODS": null,
      "ENVIRONMENT": null,
      "NODE_ENV": null,
      "CONFIRM_PROD": null
    },
    "expect_exit_code": 0,
    "expect": { "status": "success", "execution_id": "exec_mock_notion_write_001" },
    "expect_file_exists": "runs/notion-write/exec_mock_notion_write_001.write-page-property.json",
    "post_assert": {
      "artifact_dir": "runs/notion-write",
      "contains_keys": ["request_payload", "response", "action", "execution_id", "approved_at"],
      "contains_subset": { "response": { "updated": true } }
    }
  }
  ,
  {
    "name": "notion-title-write-pauses",
    "stage": "cli",
    "command": "/notion title pg_001 \"New Title\"",
    "expect": { "kind": "ApprovalRequired" },
    "expect_exit_code": 4,
    "post_assert": { "approval_state": true }
  },
  {
    "name": "notion-title-write-approve-resumes",
    "stage": "cli",
    "command": "/approve exec_mock_notion_title_001",
    "post_assert": {
      "artifact_dir": "runs/notion-write",
      "contains_keys": ["updated", "title"]
    }
  }
  ,
  {
    "name": "tier7-orchestration-pauses-at-write",
    "stage": "cli",
    "command": "/orchestrate notion-status db_001 pg_001",
    "expect": { "kind": "ApprovalRequired" },
    "expect_exit_code": 4,
    "post_assert": { "approval_state": true }
  },
  {
    "name": "tier7-orchestration-approve-completes",
    "stage": "cli",
    "command": "/approve exec_mock_orchestration_001",
    "post_assert": {
      "artifact_dir": "runs/notion",
      "contains_keys": ["properties"]
    }
  }
  ,
  {
    "name": "tier8-read-only-autonomy-happy",
    "stage": "cli",
    "env": {
      "AUTONOMY_MODE": "READ_ONLY_AUTONOMY"
    },
    "command": "/notion db db_001",
    "expect": { "status": "success" },
    "post_assert": {
      "artifact_dir": "runs/autonomy",
      "contains_keys": ["execution_id", "mode"]
    }
  },
  {
    "name": "tier8-read-only-autonomy-write-denied",
    "stage": "cli",
    "env": {
      "AUTONOMY_MODE": "READ_ONLY_AUTONOMY"
    },
    "command": "/notion set pg_001 Status=Done",       
    "expect": {
      "kind": "PolicyDenied",
      "code": "AUTONOMY_READ_ONLY_VIOLATION"
    },
    "expect_exit_code": 3
  },
  {
    "name": "tier9-prestate-written-on-approval",
    "stage": "cli",
    "command": "/notion set pg_001 Status=Done",
    "expect": { "kind": "ApprovalRequired" },
    "expect_exit_code": 4,
    "post_assert": {
      "artifact_dir": "runs/prestate",
      "contains_keys": ["execution_id", "plan_hash", "snapshot"]
    }
  },
  {
    "name": "tier9-rollback-recorded",
    "stage": "cli",
    "command": "/rollback policy_deny_prod_write_001",
    "expect": { "kind": "RollbackRecorded" },
    "post_assert": {
      "artifact_dir": "runs/rollback",
      "contains_keys": ["compensation_plan", "rolled_back_execution_id"]
    }
  }
  ,
  {
    "name": "tier10-notion-live-read-redacted",
    "stage": "cli",
    "command": "/notion live db db_001",
    "env": {
      "ALLOWED_DOMAINS": null,
      "ALLOWED_METHODS": null,
      "ENVIRONMENT": null,
      "NODE_ENV": null,
      "CONFIRM_PROD": null,
      "NOTION_API_BASE": "http://localhost:8787",
      "NOTION_API_VERSION": "2022-06-28",
      "NOTION_TOKEN": "local_mock_token",
      "NOTION_REDACT_KEYS": "title,name"
    },
    "expect": { "status": "success" },
    "post_assert": {
      "artifact_dir": "runs/notion-live-read",
      "contains_keys": ["execution_id", "step_id", "notion_path", "http_status", "response"],
      "contains_subset": { "response": { "title": "[REDACTED]", "name": "[REDACTED]" } }
    }
  },
  {
    "name": "tier10-notion-live-write-denied",
    "stage": "cli",
    "command": "/notion live write db_001",
    "env": {
      "ALLOWED_DOMAINS": null,
      "ALLOWED_METHODS": null,
      "ENVIRONMENT": null,
      "NODE_ENV": null,
      "CONFIRM_PROD": null,
      "NOTION_API_BASE": "http://localhost:8787",
      "NOTION_API_VERSION": "2022-06-28",
      "NOTION_TOKEN": "local_mock_token",
      "NOTION_REDACT_KEYS": "title,name"
    },
    "expect_exit_code": 3,
    "expect": { "kind": "PolicyDenied", "code": "NOTION_LIVE_REQUIRES_READ_ONLY" }
  },
  {
    "name": "tier10_2-live-write-pauses",
    "stage": "cli",
    "command": "/notion live set pg_001 Status=Done",
    "env": {
      "ALLOWED_DOMAINS": null,
      "ALLOWED_METHODS": null,
      "ENVIRONMENT": null,
      "NODE_ENV": null,
      "CONFIRM_PROD": null,
      "NOTION_API_BASE": "http://localhost:8787",
      "NOTION_API_VERSION": "2022-06-28",
      "NOTION_TOKEN": "local_mock_token",
      "NOTION_REDACT_KEYS": "title,name",
      "NOTION_LIVE_APPROVE_RECHECK": "1"
    },
    "expect": { "kind": "ApprovalRequired" },
    "expect_exit_code": 4,
    "post_assert": {
      "artifact_dir": "runs/prestate",
      "contains_keys": ["execution_id", "snapshot"]
    }
  },
  {
    "name": "tier10_2-approve-resumes-and-writes-artifact",
    "stage": "cli",
    "command": "/approve tier10_2-live-write-pauses_001",
    "env": {
      "ALLOWED_DOMAINS": null,
      "ALLOWED_METHODS": null,
      "ENVIRONMENT": null,
      "NODE_ENV": null,
      "CONFIRM_PROD": null,
      "NOTION_API_BASE": "http://localhost:8787",
      "NOTION_API_VERSION": "2022-06-28",
      "NOTION_TOKEN": "local_mock_token",
      "NOTION_REDACT_KEYS": "title,name",
      "NOTION_LIVE_APPROVE_RECHECK": "1"
    },
    "expect": { "status": "success" },
    "post_assert": {
      "artifact_dir": "runs/notion-live-write",
      "contains_keys": ["request_properties", "approved_at", "response"]
    }
  },
  {
    "name": "tier10_3-bundle-pauses",
    "stage": "cli",
    "command": "/notion live set pg_001 Status=Done Priority=High",
    "env": {
      "ALLOWED_DOMAINS": null,
      "ALLOWED_METHODS": null,
      "ENVIRONMENT": null,
      "NODE_ENV": null,
      "CONFIRM_PROD": null,
      "NOTION_API_BASE": "http://localhost:8787",
      "NOTION_API_VERSION": "2022-06-28",
      "NOTION_TOKEN": "local_mock_token",
      "NOTION_REDACT_KEYS": "title,name",
      "NOTION_LIVE_APPROVE_RECHECK": "1"
    },
    "expect": { "kind": "ApprovalRequired" },
    "expect_exit_code": 4,
    "post_assert": {
      "artifact_dir": "runs/prestate",
      "contains_keys": ["execution_id", "snapshot"]
    }
  },
  {
    "name": "tier10_3-bundle-approve-resumes-and-writes-artifact",
    "stage": "cli",
    "command": "/approve tier10_3-bundle-pauses_001",
    "env": {
      "ALLOWED_DOMAINS": null,
      "ALLOWED_METHODS": null,
      "ENVIRONMENT": null,
      "NODE_ENV": null,
      "CONFIRM_PROD": null,
      "NOTION_API_BASE": "http://localhost:8787",
      "NOTION_API_VERSION": "2022-06-28",
      "NOTION_TOKEN": "local_mock_token",
      "NOTION_REDACT_KEYS": "title,name",
      "NOTION_LIVE_APPROVE_RECHECK": "1"
    },
    "expect": { "status": "success" },
    "post_assert": {
      "artifact_dir": "runs/notion-live-write",
      "contains_keys": ["request_properties", "bundle_keys", "approved_at", "response"]
    }
  },
  {
    "name": "tier10_4-guard-pauses",
    "stage": "cli",
    "command": "/notion live set pg_001 Status=Done --if Status!=Done",
    "env": {
      "ALLOWED_DOMAINS": null,
      "ALLOWED_METHODS": null,
      "ENVIRONMENT": null,
      "NODE_ENV": null,
      "CONFIRM_PROD": null,
      "NOTION_API_BASE": "http://localhost:8787",
      "NOTION_API_VERSION": "2022-06-28",
      "NOTION_TOKEN": "local_mock_token",
      "NOTION_REDACT_KEYS": "title,name",
      "NOTION_LIVE_APPROVE_RECHECK": "1"
    },
    "expect": { "kind": "ApprovalRequired" },
    "expect_exit_code": 4
  },
  {
    "name": "tier10_4-guard-fails-on-resume",
    "stage": "cli",
    "command": "/approve tier10_4-guard-pauses_001",
    "env": {
      "ALLOWED_DOMAINS": null,
      "ALLOWED_METHODS": null,
      "ENVIRONMENT": null,
      "NODE_ENV": null,
      "CONFIRM_PROD": null,
      "NOTION_API_BASE": "http://localhost:8787",
      "NOTION_API_VERSION": "2022-06-28",
      "NOTION_TOKEN": "local_mock_token",
      "NOTION_REDACT_KEYS": "title,name",
      "NOTION_LIVE_APPROVE_RECHECK": "1"
    },
    "expect": { "kind": "NeedApprovalAgain", "code": "GUARD_FAILED_PRE_EXEC" },
    "expect_exit_code": 4
  },
  {
    "name": "tier10_5-idempotency-hit-simple",
    "stage": "cli",
    "command": "/approve tier10_2-live-write-pauses_001",
    "env": {
      "ALLOWED_DOMAINS": null,
      "ALLOWED_METHODS": null,
      "ENVIRONMENT": null,
      "NODE_ENV": null,
      "CONFIRM_PROD": null,
      "NOTION_API_BASE": "http://localhost:8787",
      "NOTION_API_VERSION": "2022-06-28",
      "NOTION_TOKEN": "local_mock_token",
      "NOTION_REDACT_KEYS": "title,name",
      "NOTION_LIVE_APPROVE_RECHECK": "1"
    },
    "expect": { "kind": "AlreadyExecuted", "code": "IDEMPOTENCY_HIT" }
  },
  {
    "name": "tier10_5-idempotency-hit-bundle",
    "stage": "cli",
    "command": "/approve tier10_3-bundle-pauses_001",
    "env": {
      "ALLOWED_DOMAINS": null,
      "ALLOWED_METHODS": null,
      "ENVIRONMENT": null,
      "NODE_ENV": null,
      "CONFIRM_PROD": null,
      "NOTION_API_BASE": "http://localhost:8787",
      "NOTION_API_VERSION": "2022-06-28",
      "NOTION_TOKEN": "local_mock_token",
      "NOTION_REDACT_KEYS": "title,name",
      "NOTION_LIVE_APPROVE_RECHECK": "1"
    },
    "expect": { "kind": "AlreadyExecuted", "code": "IDEMPOTENCY_HIT" }
  },
  {
    "name": "tier10_6-batch-pauses-once",
    "stage": "cli",
    "command": "/notion live bundle pg_001 Status=Done Priority=High Owner=Isiah",
    "env": {
      "ALLOWED_DOMAINS": null,
      "ALLOWED_METHODS": null,
      "ENVIRONMENT": null,
      "NODE_ENV": null,
      "CONFIRM_PROD": null,
      "NOTION_API_BASE": "http://localhost:8787",
      "NOTION_API_VERSION": "2022-06-28",
      "NOTION_TOKEN": "local_mock_token",
      "NOTION_REDACT_KEYS": "title,name",
      "NOTION_LIVE_APPROVE_RECHECK": "1"
    },
    "expect": { "kind": "ApprovalRequiredBatch" },
    "expect_exit_code": 4,
    "post_assert": {
      "artifact_dir": "runs/approvals",
      "contains_keys": ["pending_step_ids", "plan_hash", "status"]
    }
  },
  {
    "name": "tier10_6-approve-executes-all",
    "stage": "cli",
    "command": "/approve tier10_6-batch-pauses-once_001",
    "env": {
      "ALLOWED_DOMAINS": null,
      "ALLOWED_METHODS": null,
      "ENVIRONMENT": null,
      "NODE_ENV": null,
      "CONFIRM_PROD": null,
      "NOTION_API_BASE": "http://localhost:8787",
      "NOTION_API_VERSION": "2022-06-28",
      "NOTION_TOKEN": "local_mock_token",
      "NOTION_REDACT_KEYS": "title,name",
      "NOTION_LIVE_APPROVE_RECHECK": "1"
    },
    "expect": { "kind": "BatchApprovedExecuted" },
    "post_assert": {
      "artifact_dir": "runs/notion-live-write",
      "contains_keys": ["approved_at", "request_properties"]
    }
  },
  {
    "name": "tier10_7-template-run-pauses-once",
    "stage": "cli",
    "command": "/template run close_case {\"page_id\":\"pg_001\",\"status\":\"Closed\",\"reason\":\"Docs received\"}",
    "env": {
      "ALLOWED_DOMAINS": null,
      "ALLOWED_METHODS": null,
      "ENVIRONMENT": null,
      "NODE_ENV": null,
      "CONFIRM_PROD": null,
      "NOTION_API_BASE": "http://localhost:8787",
      "NOTION_API_VERSION": "2022-06-28",
      "NOTION_TOKEN": "local_mock_token",
      "NOTION_REDACT_KEYS": "title,name",
      "NOTION_LIVE_APPROVE_RECHECK": "1"
    },
    "expect": { "kind": "ApprovalRequiredBatch" },
    "expect_exit_code": 4,
    "post_assert": {
      "artifact_dir": "runs/approvals",
      "contains_keys": ["pending_step_ids", "plan_hash", "status"]
    }
  },
  {
    "name": "tier10_7-template-run-approve-executes-batch",
    "stage": "cli",
    "command": "/approve tier10_7-template-run-close_case_pg_001",
    "env": {
      "ALLOWED_DOMAINS": null,
      "ALLOWED_METHODS": null,
      "ENVIRONMENT": null,
      "NODE_ENV": null,
      "CONFIRM_PROD": null,
      "NOTION_API_BASE": "http://localhost:8787",
      "NOTION_API_VERSION": "2022-06-28",
      "NOTION_TOKEN": "local_mock_token",
      "NOTION_REDACT_KEYS": "title,name",
      "NOTION_LIVE_APPROVE_RECHECK": "1"
    },
    "expect": { "kind": "BatchApprovedExecuted" },
    "post_assert": {
      "artifact_dir": "runs/notion-live-write",
      "contains_keys": ["approved_at", "request_properties"]
    }
  },
  {
    "name": "tier11-queue-list",
    "stage": "cli",
    "command": "/queue list",
    "expect": { "kind": "QueueList" }
  },
  {
    "name": "tier11-reject-run",
    "stage": "cli",
    "command": "/queue reject exec_123 \"Docs incomplete\"",
    "expect": { "kind": "RunRejected", "execution_id": "exec_123" }
  },
  {
    "name": "tier12-run-show",
    "stage": "cli",
    "command": "/run show exec_123",
    "expect": { "kind": "RunDetails" }
  },
  {
    "name": "tier12-run-artifacts",
    "stage": "cli",
    "command": "/run artifacts exec_123",
    "expect": { "kind": "ArtifactIndex" }
  },
  {
    "name": "tier13-explain-blocked-by-dedup",
    "stage": "cli",
    "command": "/scheduler explain notion_tax_cases_daily_scan --at 2024-01-08T09:15:30Z",
    "expect": {
      "kind": "SchedulerExplain",
      "job_id": "notion_tax_cases_daily_scan",
      "would_run": false,
      "decision": "BLOCKED",
      "primary_reason": "DEDUP_ACTIVE"
    },
    "post_assert": {
      "scheduler_explain": {
        "job_id": "notion_tax_cases_daily_scan",
        "at": "2024-01-08T09:15:30Z",
        "reset_history": true,
        "seed_dedup": true,
        "seed_budget_days": [{ "day": "2024-01-08", "count": 0 }],
        "primary_reason": "DEDUP_ACTIVE",
        "would_run": false
      }
    }
  },
  {
    "name": "tier13-explain-eligible-after-budget-reset",
    "stage": "cli",
    "command": "/scheduler explain notion_tax_cases_daily_scan --at 2024-01-10T09:15:30Z",
    "expect": {
      "kind": "SchedulerExplain",
      "job_id": "notion_tax_cases_daily_scan",
      "would_run": true,
      "decision": "ELIGIBLE",
      "primary_reason": "ELIGIBLE"
    },
    "post_assert": {
      "scheduler_explain": {
        "job_id": "notion_tax_cases_daily_scan",
        "at": "2024-01-10T09:15:30Z",
        "reset_history": true,
        "seed_budget_days": [{ "day": "2024-01-09", "count": 3 }],
        "primary_reason": "ELIGIBLE",
        "would_run": true
      }
    }
  },
  {
    "name": "tier13-5-scheduler-explain-at-smoke",
    "stage": "cli",
    "command": "/scheduler explain notion_tax_cases_daily_scan --at 2024-01-10T09:15:30Z",
    "expect": {
      "kind": "SchedulerExplain",
      "job_id": "notion_tax_cases_daily_scan",
      "would_run": true,
      "decision": "ELIGIBLE",
      "primary_reason": "ELIGIBLE"
    },
    "post_assert": {
      "scheduler_explain": {
        "job_id": "notion_tax_cases_daily_scan",
        "at": "2024-01-10T09:15:30Z",
        "reset_history": true,
        "seed_budget_days": [{ "day": "2024-01-09", "count": 3 }],
        "primary_reason": "ELIGIBLE",
        "would_run": true
      }
    }
  },
  {
    "name": "tier13-history-lists",
    "stage": "cli",
    "command": "/scheduler history notion_tax_cases_daily_scan",
    "expect": {
      "kind": "SchedulerHistory"
    }
  },
  {
    "name": "tier13-history-limit",
    "stage": "cli",
    "command": "/scheduler history notion_tax_cases_daily_scan --limit 1",
    "expect": {
      "count": 1
    }
  },
  {
    "name": "tier14-policy-simulate-require-approval",
    "stage": "cli",
    "command": "/policy simulate /notion set pg_001 Status=Done",
    "expect_exit_code": 0,
    "expect": {
      "kind": "PolicySimulation",
      "decision": "REQUIRE_APPROVAL",
      "denial_code": "NOTION_WRITE_APPROVAL_REQUIRED",
      "approval_required": true
    },
    "post_assert": {
      "no_writes": {
        "paths": [
          "runs/receipts.jsonl",
          "runs/approvals",
          "runs/autonomy/state",
          "runs/scheduler",
          "runs/scheduler-history"
        ]
      }
    }
  },
  {
    "name": "tier14-policy-simulate-throttle",
    "stage": "cli",
    "command": "/policy simulate /notion db db_001",
    "env": {
      "RUN_GOVERNOR_ENABLED": "1",
      "SMOKE_FIXED_NOW_ISO": "2024-01-10T09:15:30Z",
      "AUTONOMY_TOKENS_PER_HOUR": "1"
    },
    "precondition": {
      "governor_counter": {
        "command": "/notion db db_001",
        "hour_start": "2024-01-10T09:00:00.000Z",
        "tokens_remaining": 0,
        "concurrent": 0,
        "updated_at": "2024-01-10T09:15:30Z"
      }
    },
    "expect_exit_code": 0,
    "expect": {
      "kind": "PolicySimulation",
      "decision": "THROTTLE",
      "governor": { "decision": "DELAY" }
    },
    "post_assert": {
      "no_writes": {
        "paths": [
          "runs/receipts.jsonl",
          "runs/approvals",
          "runs/autonomy/state",
          "runs/scheduler",
          "runs/scheduler-history",
          "runs/governor/counters",
          "runs/governor/circuit-breakers"
        ]
      }
    }
  },
  {
    "name": "tier14-web-ui-selftest-operator-stats",
    "stage": "cli",
    "command": "/operator-ui web selftest --command /operator stats",
    "expect_exit_code": 0,
    "expect": {
      "kind": "OperatorUiWebSelftest",
      "ok": true,
      "checks": {
        "command_json_kind": "OperatorStats"
      }
    }
  },
  {
    "name": "tier14-web-ui-selftest-operator-ui-stats",
    "stage": "cli",
    "command": "/operator-ui web selftest --command /operator-ui stats",
    "expect_exit_code": 0,
    "expect": {
      "kind": "OperatorUiWebSelftest",
      "ok": true,
      "checks": {
        "command_json_kind": "OperatorUiStats"
      }
    }
  },
  {
    "name": "tier15-policy-explain-known",
    "stage": "cli",
    "command": "/policy explain NOTION_LIVE_REQUIRES_READ_ONLY",
    "expect_exit_code": 0,
    "expect": {
      "kind": "PolicyExplain",
      "code": "NOTION_LIVE_REQUIRES_READ_ONLY",
      "severity": "deny"
    },
    "post_assert": {
      "no_writes": {
        "paths": [
          "runs/receipts.jsonl",
          "runs/approvals",
          "runs/autonomy/state",
          "runs/scheduler",
          "runs/scheduler-history"
        ]
      }
    }
  },
  {
    "name": "tier15-policy-explain-unknown",
    "stage": "cli",
    "command": "/policy explain DOES_NOT_EXIST",
    "expect_exit_code": 0,
    "expect": {
      "kind": "PolicyExplain",
      "code": "DOES_NOT_EXIST",
      "title": "Unknown policy code"
    },
    "post_assert": {
      "no_writes": {
        "paths": [
          "runs/receipts.jsonl",
          "runs/approvals",
          "runs/autonomy/state",
          "runs/scheduler",
          "runs/scheduler-history"
        ]
      }
    }
  },
  {
    "name": "tier15-audit-export-creates-bundle",
    "stage": "cli",
    "command": "/audit export {\"since_iso\":\"2025-01-01T00:00:00.000Z\",\"redact\":true,\"include_artifacts\":false}",
    "expect_exit_code": 0,
    "expect": {
      "kind": "AuditExportResult"
    },
    "post_assert": {
      "audit_export": {
        "must_contain_files": [
          "COVER.md",
          "INDEX.md",
          "EXHIBITS/A_receipts.jsonl",
          "EXHIBITS/B_artifacts_list.json",
          "EXHIBITS/C_approvals.json",
          "EXHIBITS/D_policy_snapshot.json",
          "EXHIBITS/E_constitution.md",
          "HASHES/manifest.json",
          "HASHES/manifest.sha256",
          "VERIFY/verify.cjs",
          "VERIFY/VERIFY_INSTRUCTIONS.md",
          "REDACTION/redaction_rules.json"
        ]
      }
    }
  },
  {
    "name": "tier15-audit-export-verifier-ok",
    "stage": "cli",
    "command": "/audit export {\"since_iso\":\"2025-01-01T00:00:00.000Z\",\"redact\":true,\"include_artifacts\":false}",
    "expect_exit_code": 0,
    "expect": {
      "kind": "AuditExportResult"
    },
    "post_assert": {
      "audit_verify": true
    }
  },
  {
    "name": "tier15-1-audit-execution-export-happy",
    "stage": "cli",
    "command": "/audit export tier10_2-live-write-pauses_001",
    "expect_exit_code": 0,
    "expect": {
      "kind": "AuditExecutionExportResult",
      "schema_version": "15.1",
      "execution_id": "tier10_2-live-write-pauses_001"
    },
    "post_assert": {
      "audit_execution_export": {
        "must_contain_files": [
          "manifest.json",
          "receipt.json",
          "approvals.json",
          "plan.json",
          "policy.json",
          "hashes.json",
          "verify.js"
        ],
        "must_have_zip": true,
        "verify_ok": true
      }
    }
  },
  {
    "name": "tier15-1-audit-execution-export-tamper-detects",
    "stage": "cli",
    "command": "/audit export tier10_2-live-write-pauses_001",
    "expect_exit_code": 0,
    "expect": {
      "kind": "AuditExecutionExportResult",
      "schema_version": "15.1",
      "execution_id": "tier10_2-live-write-pauses_001"
    },
    "post_assert": {
      "audit_execution_tamper": {
        "tamper_path": "receipt.json",
        "verify_should_fail": true
      }
    }
  },
  {
    "name": "tier17-ranking-order",
    "stage": "cli",
    "command": "/operator queue",
    "expect": {
      "kind": "OperatorQueue"
    },
    "post_assert": {
      "jobs[0].regression.regressed": true,
      "jobs[1].policy_state.reason": "APPROVAL_REQUIRED"
    }
  },
  {
    "name": "speech-low-confidence-silenced",
    "stage": "cli",
    "env": {
      "SPEECH_ENABLED": "1",
      "SPEECH_SINKS": "console",
      "SPEECH_CATEGORIES": "confidence",
      "SPEECH_CONFIDENCE_GRADIENT": "1",
      "SPEECH_GRADIENT_PREFIX": "1",
      "SPEECH_VOICE_BUDGET": "2",
      "SPEECH_ARTIFACTS": "1",
      "THREAD_ID": "speech_001",
      "ALLOWED_DOMAINS": null,
      "ALLOWED_METHODS": null,
      "ENVIRONMENT": null,
      "NODE_ENV": null,
      "CONFIRM_PROD": null
    },
    "command": "/speak confidence 0.2 should not speak",
    "post_assert": {
      "artifact_dir": "runs/speech-decisions",
      "contains_subset": {
        "kind": "SpeechDecision",
        "category": "confidence",
        "decision": {
          "allow": false,
          "reason": "LOW_CONFIDENCE"
        }
      }
    }
  },
  {
    "name": "speech-confidence-recovers-speaks-once",
    "stage": "cli",
    "env": {
      "SPEECH_ENABLED": "1",
      "SPEECH_SINKS": "console",
      "SPEECH_CATEGORIES": "confidence",
      "SPEECH_CONFIDENCE_GRADIENT": "1",
      "SPEECH_GRADIENT_PREFIX": "1",
      "SPEECH_VOICE_BUDGET": "1",
      "SPEECH_ARTIFACTS": "1",
      "THREAD_ID": "speech_002",
      "ALLOWED_DOMAINS": null,
      "ALLOWED_METHODS": null,
      "ENVIRONMENT": null,
      "NODE_ENV": null,
      "CONFIRM_PROD": null
    },
    "command": "/speak confidence 0.85 one\n/speak confidence 0.85 two",
    "post_assert": {
      "artifact_dir": "runs/speech-decisions",
      "contains_subset": {
        "kind": "SpeechDecision",
        "category": "confidence",
        "decision": {
          "allow": false,
          "reason": "BUDGET_EXHAUSTED"
        }
      }
    }
  },
  {
    "name": "tier17-auto-runnable-visible",
    "stage": "cli",
    "command": "/operator queue",
    "expect": {
      "kind": "OperatorQueue"
    },
    "post_assert": {
      "jobs[*].confidence.action": "AUTO_RUN"
    }
  },
  {
    "name": "tier18-ui-queue-renders-ranked-jobs",
    "stage": "cli",
    "command": "/operator-ui queue",
    "expect": { "kind": "OperatorUiQueue" },
    "post_assert": {
      "rows[0].status": "REGRESSION",
      "rows[*].confidence": { "action": "AUTO_RUN" }
    }
  },
  {
    "name": "tier18-ui-approve-emits-receipt",
    "stage": "cli",
    "command": "/operator-ui approve tier18_ui_approval_001",
    "expect": { "kind": "OperatorUiActionResult", "action": "APPROVE", "execution_id": "tier18_ui_approval_001" },
    "post_assert": {
      "receipt_subset": { "status": "success", "execution_id": "tier18_ui_approval_001" }
    }
  },
  {
    "name": "tier20-delegated-class-autorun",
    "stage": "cli",
    "command": "/notion set pg_999 Status=Done",
    "precondition": { "delegated_class": "tier20-notion-status-updates-autorun" },
    "env": {
      "AUTONOMY_MODE": "APPROVAL_GATED_AUTONOMY",
      "ALLOWED_DOMAINS": null,
      "ALLOWED_METHODS": null,
      "NODE_ENV": null,
      "CONFIRM_PROD": null
    },
    "expect": { "executed": true, "approval_required": false }
  },
  {
    "name": "tier20-delegation-suspended-on-regression",
    "stage": "cli",
    "command": "/notion set pg_999 Status=Done",
    "precondition": { "delegated_class": "tier20-notion-status-updates-regression" },
    "env": {
      "AUTONOMY_MODE": "APPROVAL_GATED_AUTONOMY",
      "ALLOWED_DOMAINS": null,
      "ALLOWED_METHODS": null,
      "NODE_ENV": null,
      "CONFIRM_PROD": null
    },
    "expect": {
      "executed": false,
      "approval_required": true,
      "delegation_active": false,
      "reason": "CONFIDENCE_REGRESSION"
    }
  },
  {
    "name": "tier21-domain-overlay-deny-write",
    "stage": "cli",
    "command": "/domain ops.notion /notion set pg_999 Status=Done",
    "env": {
      "AUTONOMY_MODE": "OFF",
      "ALLOWED_DOMAINS": null,
      "ALLOWED_METHODS": null,
      "NODE_ENV": null,
      "CONFIRM_PROD": null
    },
    "expect_exit_code": 3,
    "expect": { "kind": "PolicyDenied", "code": "DOMAIN_OVERLAY_DENY_WRITE" }
  },
  {
    "name": "tier21-role-blocks-approval",
    "stage": "cli",
    "command": "/domain ops.notion /approve exec_write_001",
    "env": {
      "AUTONOMY_MODE": "OFF",
      "ALLOWED_DOMAINS": null,
      "ALLOWED_METHODS": null,
      "NODE_ENV": null,
      "CONFIRM_PROD": null
    },
    "expect_exit_code": 3,
    "expect": { "kind": "PolicyDenied", "code": "OPERATOR_NOT_AUTHORIZED_FOR_DOMAIN" }
  },
  {
    "name": "tier-infinity-token-exhausted",
    "stage": "cli",
    "command": "/intake ./docs",
    "env": {
      "RUN_GOVERNOR_ENABLED": "1",
      "AUTONOMY_TOKENS_PER_HOUR": "1",
      "AUTONOMY_MAX_CONCURRENT": "1",
      "SMOKE_FIXED_NOW_ISO": "2025-01-01T00:00:00.000Z",
      "AUTONOMY_MODE": "APPROVAL_GATED_AUTONOMY",
      "ALLOWED_DOMAINS": null,
      "ALLOWED_METHODS": null,
      "NODE_ENV": null,
      "CONFIRM_PROD": null
    },
    "precondition": {
      "governor_counter": {
        "fingerprint": "intake.scan",
        "hour_start": "2025-01-01T00:00:00.000Z",
        "tokens_remaining": 0,
        "concurrent": 0,
        "updated_at": "2025-01-01T00:00:00.000Z"
      }
    },
    "expect_exit_code": 3,
    "expect": {
      "kind": "Throttled",
      "reason": "TOKEN_EXHAUSTED",
      "retry_after": "2025-01-01T01:00:00.000Z"
    },
    "post_assert": {
      "no_writes": { "paths": ["runs/intake"] },
      "receipt_subset": { "status": "throttled", "policy_code": "TOKEN_EXHAUSTED" }
    }
  },
  {
    "name": "tier-infinity-circuit-breaker-opens",
    "stage": "cli",
    "command": "/intake ./docs",
    "env": {
      "RUN_GOVERNOR_ENABLED": "1",
      "REQUALIFICATION_ENABLED": "1",
      "AUTONOMY_CB_ROLLBACKS": "1",
      "AUTONOMY_CB_OPEN_HOURS": "1",
      "SMOKE_FIXED_NOW_ISO": "2025-01-01T00:00:00.000Z",
      "AUTONOMY_MODE": "APPROVAL_GATED_AUTONOMY",
      "ALLOWED_DOMAINS": null,
      "ALLOWED_METHODS": null,
      "NODE_ENV": null,
      "CONFIRM_PROD": null
    },
    "precondition": {
      "rollback_artifacts": [
        { "kind": "RollbackArtifact", "fingerprint": "intake.scan", "at": "2025-01-01T00:00:00.000Z" }
      ]
    },
    "expect_exit_code": 3,
    "expect": {
      "kind": "Throttled",
      "reason": "CIRCUIT_OPEN",
      "retry_after": "2025-01-01T01:00:00.000Z"
    },
    "post_assert": {
      "receipt_subset": { "status": "throttled", "policy_code": "CIRCUIT_OPEN" },
      "artifact_dir": "runs/governor/circuit-breakers",
      "contains_keys": ["fingerprint", "opened_at", "open_until", "reason", "counts"],
      "contains_subset": { "fingerprint": "intake.scan", "reason": "ROLLBACK_THRESHOLD" }
    }
  },
  {
    "name": "tier22-suspended-enters-probation",
    "stage": "cli",
    "command": "/autonomy requalify scan",
    "env": {
      "SMOKE_FIXED_NOW_ISO": "2025-01-01T00:00:00.000Z",
      "AUTONOMY_MODE": "OFF",
      "ALLOWED_DOMAINS": null,
      "ALLOWED_METHODS": null,
      "NODE_ENV": null,
      "CONFIRM_PROD": null
    },
    "precondition": {
      "requalification_state": {
        "fingerprint": "notion.write.page",
        "state": "SUSPENDED",
        "cause": "seeded",
        "since": "2025-01-01T00:00:00.000Z",
        "cooldown_until": "2025-01-01T00:00:00.000Z"
      }
    },
    "expect": {
      "kind": "RequalificationScan",
      "evaluated": 1,
      "eligible": [],
      "still_suspended": []
    },
    "post_assert": {
      "artifact_dir": "runs/requalification/state",
      "contains_keys": ["fingerprint", "state", "cause", "since", "cooldown_until"],
      "contains_subset": { "fingerprint": "notion.write.page", "state": "PROBATION" }
    }
  },
  {
    "name": "tier22_1-probation-success-increments",
    "stage": "cli",
    "command": "/notion live db db_001",
    "env": {
      "REQUALIFICATION_ENABLED": "1",
      "PROBATION_SUCCESS_REQUIRED": "3",
      "SMOKE_FIXED_NOW_ISO": "2025-01-02T00:00:00.000Z",
      "AUTONOMY_MODE": "OFF",
      "ALLOWED_DOMAINS": null,
      "ALLOWED_METHODS": null,
      "NODE_ENV": null,
      "CONFIRM_PROD": null,
      "NOTION_API_BASE": "http://localhost:8787",
      "NOTION_API_VERSION": "2022-06-28",
      "NOTION_TOKEN": "local_mock_token",
      "NOTION_REDACT_KEYS": "title,name"
    },
    "precondition": {
      "requalification_state": {
        "fingerprint": "notion.write.page",
        "state": "PROBATION",
        "cause": "seeded",
        "since": "2025-01-02T00:00:00.000Z",
        "cooldown_until": null
      }
    },
    "expect": { "status": "success" },
    "post_assert": {
      "artifact_dir": "runs/requalification/probation",
      "contains_subset": {
        "fingerprint": "notion.write.page",
        "state": "PROBATION",
        "success_count": 1,
        "required_successes": 3,
        "last_success_at": "2025-01-02T00:00:00.000Z"
      }
    }
  },
  {
    "name": "tier22-cooldown-auto-probation",
    "stage": "cli",
    "command": "/autonomy requalify scan",
    "env": {
      "REQUALIFICATION_ENABLED": "1",
      "SMOKE_FIXED_NOW_ISO": "2025-01-02T00:00:00.000Z",
      "AUTONOMY_MODE": "OFF",
      "ALLOWED_DOMAINS": null,
      "ALLOWED_METHODS": null,
      "NODE_ENV": null,
      "CONFIRM_PROD": null
    },
    "precondition": {
      "requalification_state": {
        "fingerprint": "notion.write.page",
        "state": "SUSPENDED",
        "cause": "seeded",
        "since": "2025-01-01T00:00:00.000Z",
        "cooldown_until": "2025-01-01T00:00:00.000Z"
      }
    },
    "expect": { "kind": "RequalificationScan" },
    "expect_file_exists": "runs/requalification/events/notion.write.page.1735776000000.json",
    "post_assert": {
      "artifact_dir": "runs/requalification/state",
      "contains_keys": ["fingerprint", "state", "cause", "since", "cooldown_until"],
      "contains_subset": { "fingerprint": "notion.write.page", "state": "PROBATION", "cause": "COOLDOWN_ELAPSED" },
      "receipt_subset": {
        "execution_id": "autonomy_transition_notion-write-page_1735776000000",
        "kind": "AutonomyStateTransition",
        "fingerprint": "notion.write.page"
      }
    }
  },
  {
    "name": "tier22_1-probation-recommends-eligible",
    "stage": "cli",
    "repeat": 3,
    "command": "/notion live db db_001",
    "env": {
      "REQUALIFICATION_ENABLED": "1",
      "PROBATION_SUCCESS_REQUIRED": "3",
      "SMOKE_FIXED_NOW_ISO": "2025-01-02T00:00:00.000Z",
      "AUTONOMY_MODE": "OFF",
      "ALLOWED_DOMAINS": null,
      "ALLOWED_METHODS": null,
      "NODE_ENV": null,
      "CONFIRM_PROD": null,
      "NOTION_API_BASE": "http://localhost:8787",
      "NOTION_API_VERSION": "2022-06-28",
      "NOTION_TOKEN": "local_mock_token",
      "NOTION_REDACT_KEYS": "title,name"
    },
    "precondition": {
      "requalification_state": {
        "fingerprint": "notion.write.page",
        "state": "PROBATION",
        "cause": "seeded",
        "since": "2025-01-02T00:00:00.000Z",
        "cooldown_until": null
      }
    },
    "expect": { "status": "success" },
    "expect_file_exists": "runs/requalification/events/notion.write.page.1735776000000.json",
    "post_assert": {
      "artifact_dir": "runs/requalification/events",
      "contains_subset": {
        "event": "RequalificationRecommended",
        "fingerprint": "notion.write.page",
        "confidence": 1,
        "success_count": 3
      },
      "receipt_subset": {
        "kind": "RequalificationRecommended",
        "fingerprint": "notion.write.page",
        "recommendation": "ELIGIBLE"
      }
    }
  },
  {
    "name": "tier22-no-auto-activation",
    "stage": "cli",
    "command": "/notion live db db_001",
    "env": {
      "REQUALIFICATION_ENABLED": "1",
      "PROBATION_SUCCESS_REQUIRED": "3",
      "SMOKE_FIXED_NOW_ISO": "2025-01-02T00:00:00.000Z",
      "AUTONOMY_MODE": "OFF",
      "ALLOWED_DOMAINS": null,
      "ALLOWED_METHODS": null,
      "NODE_ENV": null,
      "CONFIRM_PROD": null,
      "NOTION_API_BASE": "http://localhost:8787",
      "NOTION_API_VERSION": "2022-06-28",
      "NOTION_TOKEN": "local_mock_token",
      "NOTION_REDACT_KEYS": "title,name"
    },
    "precondition": {
      "requalification_state": {
        "fingerprint": "notion.write.page",
        "state": "ELIGIBLE",
        "cause": "seeded",
        "since": "2025-01-02T00:00:00.000Z",
        "cooldown_until": null
      }
    },
    "expect": { "status": "success" },
    "post_assert": {
      "artifact_dir": "runs/requalification/state",
      "contains_subset": { "fingerprint": "notion.write.page", "state": "ELIGIBLE" }
    }
  },
  {
    "name": "tier22-activate-eligible",
    "stage": "cli",
    "command": "/autonomy requalify activate notion.write.page",
    "env": {
      "REQUALIFICATION_ENABLED": "1",
      "SMOKE_FIXED_NOW_ISO": "2025-01-02T00:00:00.000Z",
      "AUTONOMY_MODE": "OFF",
      "ALLOWED_DOMAINS": null,
      "ALLOWED_METHODS": null,
      "NODE_ENV": null,
      "CONFIRM_PROD": null
    },
    "precondition": {
      "requalification_state": {
        "fingerprint": "notion.write.page",
        "state": "ELIGIBLE",
        "cause": "seeded",
        "since": "2025-01-02T00:00:00.000Z",
        "cooldown_until": null
      }
    },
    "expect": {
      "kind": "ActivationApproved",
      "state": "ACTIVE"
    }
  },
  {
    "name": "tier22-activate-denied-not-eligible",
    "stage": "cli",
    "command": "/autonomy requalify activate tax.write.estimate",
    "env": {
      "REQUALIFICATION_ENABLED": "1",
      "SMOKE_FIXED_NOW_ISO": "2025-01-02T00:00:00.000Z",
      "AUTONOMY_MODE": "OFF",
      "ALLOWED_DOMAINS": null,
      "ALLOWED_METHODS": null,
      "NODE_ENV": null,
      "CONFIRM_PROD": null
    },
    "expect": {
      "kind": "ActivationDenied",
      "reason": "NOT_ELIGIBLE"
    },
    "expect_exit_code": 3
  },
  {
    "name": "tier-infinity-activation-token-exhausted",
    "stage": "cli",
    "repeat": 2,
    "command": "/autonomy requalify activate notion.write.page",
    "env": {
      "REQUALIFICATION_ENABLED": "1",
      "SMOKE_FIXED_NOW_ISO": "2025-01-02T00:00:00.000Z",
      "ACTIVATE_TOKENS_PER_HOUR": "1",
      "ACTIVATE_MAX_CONCURRENT": "1",
      "AUTONOMY_MODE": "OFF",
      "ALLOWED_DOMAINS": null,
      "ALLOWED_METHODS": null,
      "NODE_ENV": null,
      "CONFIRM_PROD": null
    },
    "precondition": {
      "requalification_state": {
        "fingerprint": "notion.write.page",
        "state": "ELIGIBLE",
        "cause": "seeded",
        "since": "2025-01-02T00:00:00.000Z",
        "cooldown_until": null
      }
    },
    "expect": {
      "kind": "Throttled",
      "scope": "activation",
      "reason": "TOKEN_EXHAUSTED"
    },
    "expect_exit_code": 3
  },
  {
    "name": "tier-infinity-activation-circuit-open",
    "stage": "cli",
    "command": "/autonomy requalify activate notion.write.page",
    "env": {
      "REQUALIFICATION_ENABLED": "1",
      "SMOKE_FIXED_NOW_ISO": "2025-01-02T00:00:00.000Z",
      "ACTIVATE_TOKENS_PER_HOUR": "1",
      "ACTIVATE_MAX_CONCURRENT": "1",
      "AUTONOMY_MODE": "OFF",
      "ALLOWED_DOMAINS": null,
      "ALLOWED_METHODS": null,
      "NODE_ENV": null,
      "CONFIRM_PROD": null
    },
    "precondition": {
      "requalification_state": {
        "fingerprint": "notion.write.page",
        "state": "ELIGIBLE",
        "cause": "seeded",
        "since": "2025-01-02T00:00:00.000Z",
        "cooldown_until": null
      }
    },
    "inject": {
      "circuit_open": true,
      "fingerprint": "autonomy.activate"
    },
    "expect": {
      "kind": "Throttled",
      "scope": "activation",
      "reason": "CIRCUIT_OPEN"
    },
    "expect_exit_code": 3
  },
  {
    "name": "tier-infinity-requalify-token-exhausted",
    "stage": "cli",
    "command": "/autonomy requalify scan",
    "repeat": 3,
    "env": {
      "SMOKE_FIXED_NOW_ISO": "2025-01-01T00:00:00.000Z",
      "REQUALIFY_TOKENS_PER_HOUR": "2",
      "REQUALIFY_MAX_CONCURRENT": "1",
      "AUTONOMY_MODE": "OFF",
      "ALLOWED_DOMAINS": null,
      "ALLOWED_METHODS": null,
      "NODE_ENV": null,
      "CONFIRM_PROD": null
    },
    "expect": {
      "kind": "Throttled",
      "reason": "TOKEN_EXHAUSTED"
    },
    "expect_exit_code": 3
  },
  {
    "name": "tier-infinity-requalify-circuit-open",
    "stage": "cli",
    "command": "/autonomy requalify scan",
    "env": {
      "SMOKE_FIXED_NOW_ISO": "2025-01-01T00:00:00.000Z",
      "REQUALIFY_TOKENS_PER_HOUR": "2",
      "REQUALIFY_MAX_CONCURRENT": "1",
      "AUTONOMY_MODE": "OFF",
      "ALLOWED_DOMAINS": null,
      "ALLOWED_METHODS": null,
      "NODE_ENV": null,
      "CONFIRM_PROD": null
    },
    "inject": {
      "circuit_open": true,
      "fingerprint": "autonomy.requalify"
    },
    "expect": {
      "kind": "Throttled",
      "reason": "CIRCUIT_OPEN"
    },
    "expect_exit_code": 3
  },
  {
    "name": "tier23-confidence-decays-to-probation",
    "stage": "cli",
    "command": "/tier23 ping",
    "env": {
      "SMOKE_FIXED_NOW_ISO": "2025-01-01T00:00:00.000Z",
      "REQUALIFICATION_ENABLED": "1",
      "CONFIDENCE_DECAY_HOURS": "72",
      "CONFIDENCE_MIN_SUCCESS": "1",
      "AUTONOMY_MODE": "OFF",
      "ALLOWED_DOMAINS": null,
      "ALLOWED_METHODS": null,
      "NODE_ENV": null,
      "CONFIRM_PROD": null
    },
    "precondition": {
      "requalification_state": {
        "command": "/tier23 ping",
        "fingerprint": "916b8ac414809fd92c7b0ed199abf76d064487029c55321c6d3af39fa5b7fe60",
        "state": "ACTIVE",
        "cause": "seeded",
        "since": "2024-12-01T00:00:00.000Z",
        "cooldown_until": null
      }
    },
    "expect": {
      "kind": "ConfidenceDecayed",
      "to": "PROBATION",
      "reason": "STALE_CONFIDENCE"
    },
    "expect_exit_code": 4,
    "post_assert": {
      "artifact_dir": "runs/confidence/events",
      "contains_subset": {
        "from": "ACTIVE",
        "to": "PROBATION",
        "reason": "STALE_CONFIDENCE"
      }
    }
  },
  {
    "name": "tier23-no-decay-with-recent-success",
    "stage": "cli",
    "command": "/intake ./docs",
    "env": {
      "SMOKE_FIXED_NOW_ISO": "2025-01-01T00:00:00.000Z",
      "REQUALIFICATION_ENABLED": "1",
      "CONFIDENCE_DECAY_HOURS": "72",
      "CONFIDENCE_MIN_SUCCESS": "1",
      "AUTONOMY_MODE": "OFF",
      "ALLOWED_DOMAINS": null,
      "ALLOWED_METHODS": null,
      "NODE_ENV": null,
      "CONFIRM_PROD": null
    },
    "precondition": {
      "requalification_state": {
        "fingerprint": "intake.scan",
        "state": "ACTIVE",
        "cause": "seeded",
        "since": "2024-12-01T00:00:00.000Z",
        "cooldown_until": null
      },
      "receipts_append": [
        {
          "execution_id": "tier23_seed_intake_scan_success_001",
          "fingerprint": "intake.scan",
          "kind": "success",
          "status": "success",
          "finished_at": "2024-12-31T23:00:00.000Z"
        }
      ]
    },
    "expect": {
      "status": "success"
    }
  },
  {
    "name": "tier17-rankings-compute-writes-artifacts",
    "stage": "cli",
    "command": "/rankings compute 7",
    "expect_subset": { "kind": "RankingsComputed", "window_days": 7 },
    "post_assert": {
      "artifact_dir": "runs/rankings/operators",
      "contains_keys": ["score", "signals"]
    }
  },
  {
    "name": "tier17-rankings-penalize-on-rollback-signal",
    "stage": "cli",
    "command": "/rankings compute 1",
    "expect_subset": { "kind": "RankingsComputed", "window_days": 1 },
    "post_assert": {
      "artifact_dir": "runs/rankings/bundles",
      "contains_keys": ["operators", "fingerprints", "domains"]
    }
  },
  {
    "name": "tier19-promotion-recommend-outputs-json",
    "stage": "cli",
    "command": "/autonomy promote recommend {\"windowRuns\":1,\"minAvgScore\":85,\"minAgeDays\":0}",
    "expect_subset": { "kind": "PromotionCandidatesRecommended" },
    "post_assert": {
      "artifact_dir": "runs/autonomy-promotion-candidates",
      "contains_keys": ["kind", "candidates"]
    }
  },
  {
    "name": "tier19-promotion-recommend-writes-artifact",
    "stage": "cli",
    "command": "/autonomy promote recommend",
    "expect_subset": { "kind": "PromotionCandidatesRecommended" },
    "post_assert": {
      "artifact_dir": "runs/autonomy-promotion-candidates",
      "contains_keys": ["kind", "window_runs", "min_avg_score", "min_age_days", "candidates"]
    }
  },
  {
    "name": "tier16-confidence-decays-on-policy-denial",
    "stage": "cli",
    "command": "/notion live write db_001",
    "env": {
      "ALLOWED_DOMAINS": null,
      "ALLOWED_METHODS": null,
      "ENVIRONMENT": null,
      "NODE_ENV": null,
      "CONFIRM_PROD": null,
      "NOTION_API_BASE": "http://localhost:8787",
      "NOTION_API_VERSION": "2022-06-28",
      "NOTION_TOKEN": "local_mock_token",
      "NOTION_REDACT_KEYS": "title,name"
    },
    "expect_exit_code": 3,
    "expect": { "kind": "PolicyDenied", "code": "NOTION_LIVE_REQUIRES_READ_ONLY" },
    "expect_file_exists": "runs/confidence/notion.write.page.json",
    "post_assert": {
      "artifact_dir": "runs/confidence",
      "contains_subset": { "fingerprint": "notion.write.page", "confidence": 0.8 }
    }
  },
  {
    "name": "tier16-confidence-suspends-and-denies-next-run-preplanning",
    "stage": "cli",
    "repeat": 5,
    "command": "/notion live write db_001",
    "env": {
      "REQUALIFICATION_ENABLED": "1",
      "ALLOWED_DOMAINS": null,
      "ALLOWED_METHODS": null,
      "ENVIRONMENT": null,
      "NODE_ENV": null,
      "CONFIRM_PROD": null,
      "NOTION_API_BASE": "http://localhost:8787",
      "NOTION_API_VERSION": "2022-06-28",
      "NOTION_TOKEN": "local_mock_token",
      "NOTION_REDACT_KEYS": "title,name"
    },
    "expect_exit_code": 3,
    "expect": { "kind": "PolicyDenied", "code": "REQUALIFICATION_BLOCKED" },
    "expect_file_exists": "runs/requalification/state/notion.write.page.json",
    "post_assert": {
      "artifact_dir": "runs/requalification/state",
      "contains_subset": { "fingerprint": "notion.write.page", "state": "SUSPENDED", "cause": "CONFIDENCE_TOO_LOW" }
    }
  }
]