services:
  mysql:
    image: mysql:8.0
    container_name: sintraprime-mysql
    restart: unless-stopped
    command:
      - mysqld
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_0900_ai_ci
      - --max_connections=200
      - --sql_mode=STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION
      - --innodb-buffer-pool-size=256M
      - --innodb-log-file-size=128M
      - --innodb-flush-log-at-trx-commit=2
      - --slow-query-log=1
      - --long-query-time=1
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      TZ: UTC
    ports:
      - "3306:3306"
    volumes:
      - sintraprime_mysql_data:/var/lib/mysql
      - ./mysql/init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -uroot -p$$MYSQL_ROOT_PASSWORD"]
      interval: 5s
      timeout: 3s
      retries: 20
    networks:
      - sintraprime-network

  # ─── Phase 2: Redis Cache ──────────────────────────────────────────────────
  # Use this for local/self-hosted. For Manus deployment, use Upstash Redis
  # and set REDIS_URL env var in your Manus dashboard instead.
  redis:
    image: redis:7-alpine
    container_name: sintraprime-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    volumes:
      - sintraprime_redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - sintraprime-network

  # ─── Phase 2: Qdrant Vector Search ────────────────────────────────────────
  # Use this for local/self-hosted. For Manus deployment, use Qdrant Cloud
  # and set QDRANT_URL + QDRANT_API_KEY env vars in your Manus dashboard.
  qdrant:
    image: qdrant/qdrant:latest
    container_name: sintraprime-qdrant
    restart: unless-stopped
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - sintraprime_qdrant_data:/qdrant/storage
    environment:
      QDRANT__SERVICE__HTTP_PORT: 6333
      QDRANT__SERVICE__GRPC_PORT: 6334
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:6333/healthz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - sintraprime-network

  # ─── Phase 2: MinIO Object Storage ───────────────────────────────────────
  # Use this for local/self-hosted. For Manus deployment, use Cloudflare R2
  # or Backblaze B2 and set S3_ENDPOINT, S3_ACCESS_KEY, S3_SECRET_KEY, S3_BUCKET
  # env vars in your Manus dashboard.
  minio:
    image: minio/minio:latest
    container_name: sintraprime-minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-sintraprime}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-sintraprime_secret_change_me}
    volumes:
      - sintraprime_minio_data:/data
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9000/minio/health/live || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - sintraprime-network

  airlock:
    build:
      context: .
      dockerfile: Dockerfile.airlock
    container_name: sintraprime-airlock
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: "3000"
      ACCEPT_ORIGIN: "*"
      MANUS_SHARED_SECRET: ${MANUS_SHARED_SECRET}
      AIRLOCK_SHARED_SECRET: ${AIRLOCK_SHARED_SECRET}
      MAKE_WEBHOOK_URL: ${MAKE_WEBHOOK_URL}
    ports:
      - "3000:3000"
    depends_on:
      - mysql
    networks:
      - sintraprime-network

  brain:
    build:
      context: .
      dockerfile: Dockerfile.brain
    container_name: sintraprime-brain
    restart: unless-stopped
    environment:
      BRAIN_ROOT: /app/brain
    ports:
      - "8011:8011"
    networks:
      - sintraprime-network

  fastapi:
    build:
      context: .
      dockerfile: Dockerfile.fastapi
    container_name: sintraprime-fastapi
    restart: unless-stopped
    environment:
      PORT: "8000"
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      QDRANT_URL: ${QDRANT_URL:-http://qdrant:6333}
      QDRANT_API_KEY: ${QDRANT_API_KEY:-}
      S3_ENDPOINT: ${S3_ENDPOINT:-http://minio:9000}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-${MINIO_ROOT_USER:-sintraprime}}
      S3_SECRET_KEY: ${S3_SECRET_KEY:-${MINIO_ROOT_PASSWORD:-sintraprime_secret_change_me}}
      S3_BUCKET: ${S3_BUCKET:-sintraprime-uploads}
    ports:
      - "8000:8000"
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      qdrant:
        condition: service_healthy
      minio:
        condition: service_healthy
    networks:
      - sintraprime-network

  webapp:
    build:
      context: .
      dockerfile: Dockerfile.webapp
    container_name: sintraprime-webapp
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: "3002"
      DATABASE_URL: mysql://${MYSQL_USER}:${MYSQL_PASSWORD}@mysql:3306/${MYSQL_DATABASE}
      JWT_SECRET: ${JWT_SECRET}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      S3_ENDPOINT: ${S3_ENDPOINT:-http://minio:9000}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-${MINIO_ROOT_USER:-sintraprime}}
      S3_SECRET_KEY: ${S3_SECRET_KEY:-${MINIO_ROOT_PASSWORD:-sintraprime_secret_change_me}}
      S3_BUCKET: ${S3_BUCKET:-sintraprime-uploads}

      # Container-to-container URLs (do not rely on SINTRA_HUB_URL inside Docker)
      SINTRA_AIRLOCK_URL: http://airlock:3000
      SINTRA_BRAIN_URL: http://brain:8011
      SINTRA_API_URL: http://fastapi:8000

      # Back-compat aliases
      AIRLOCK_URL: http://airlock:3000
      BRAIN_URL: http://brain:8011
      FASTAPI_URL: http://fastapi:8000
    ports:
      - "3002:3002"
    depends_on:
      mysql:
        condition: service_healthy
      airlock:
        condition: service_started
      brain:
        condition: service_started
      fastapi:
        condition: service_started
      redis:
        condition: service_healthy
    networks:
      - sintraprime-network

networks:
  sintraprime-network:
    driver: bridge

volumes:
  sintraprime_mysql_data:
  sintraprime_redis_data:
  sintraprime_qdrant_data:
  sintraprime_minio_data:
