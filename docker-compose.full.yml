services:
  mysql:
    image: mysql:8.0
    container_name: sintraprime-mysql
    restart: unless-stopped
    command:
      - mysqld
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_0900_ai_ci
      - --max_connections=200
      - --sql_mode=STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION
      - --innodb-buffer-pool-size=256M
      - --innodb-log-file-size=128M
      - --innodb-flush-log-at-trx-commit=2
      - --slow-query-log=1
      - --long-query-time=1
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      TZ: UTC
    ports:
      - "3306:3306"
    volumes:
      - sintraprime_mysql_data:/var/lib/mysql
      - ./mysql/init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -uroot -p$$MYSQL_ROOT_PASSWORD"]
      interval: 5s
      timeout: 3s
      retries: 20
    networks:
      - sintraprime-network

  airlock:
    build:
      context: .
      dockerfile: Dockerfile.airlock
    container_name: sintraprime-airlock
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: "3000"
      ACCEPT_ORIGIN: "*"
      MANUS_SHARED_SECRET: ${MANUS_SHARED_SECRET}
      AIRLOCK_SHARED_SECRET: ${AIRLOCK_SHARED_SECRET}
      MAKE_WEBHOOK_URL: ${MAKE_WEBHOOK_URL}
    ports:
      - "3000:3000"
    depends_on:
      - mysql
    networks:
      - sintraprime-network

  brain:
    build:
      context: .
      dockerfile: Dockerfile.brain
    container_name: sintraprime-brain
    restart: unless-stopped
    environment:
      BRAIN_ROOT: /app/brain
    ports:
      - "8011:8011"
    networks:
      - sintraprime-network

  fastapi:
    build:
      context: .
      dockerfile: Dockerfile.fastapi
    container_name: sintraprime-fastapi
    restart: unless-stopped
    environment:
      PORT: "8000"
      # Keep Redis disabled/unused unless you run a Redis service
      # REDIS_URL: redis://redis:6379/0
    ports:
      - "8000:8000"
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - sintraprime-network

  webapp:
    build:
      context: .
      dockerfile: Dockerfile.webapp
    container_name: sintraprime-webapp
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: "3002"
      DATABASE_URL: mysql://${MYSQL_USER}:${MYSQL_PASSWORD}@mysql:3306/${MYSQL_DATABASE}
      JWT_SECRET: ${JWT_SECRET}

      # Container-to-container URLs (do not rely on SINTRA_HUB_URL inside Docker)
      SINTRA_AIRLOCK_URL: http://airlock:3000
      SINTRA_BRAIN_URL: http://brain:8011
      SINTRA_API_URL: http://fastapi:8000

      # Back-compat aliases
      AIRLOCK_URL: http://airlock:3000
      BRAIN_URL: http://brain:8011
      FASTAPI_URL: http://fastapi:8000
    ports:
      - "3002:3002"
    depends_on:
      mysql:
        condition: service_healthy
      airlock:
        condition: service_started
      brain:
        condition: service_started
      fastapi:
        condition: service_started
    networks:
      - sintraprime-network

networks:
  sintraprime-network:
    driver: bridge

volumes:
  sintraprime_mysql_data:
